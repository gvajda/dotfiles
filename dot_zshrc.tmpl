# =============================================================================
# ZSH Configuration (macOS)
# =============================================================================
# Managed by Chezmoi - https://github.com/gvajda/dotfiles

# -----------------------------------------------------------------------------
# Powerlevel10k Instant Prompt (must be at the top)
# -----------------------------------------------------------------------------
if [[ -r "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh" ]]; then
  source "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh"
fi

# -----------------------------------------------------------------------------
# Homebrew (must be early for PATH)
# -----------------------------------------------------------------------------
{{- if eq .chezmoi.os "darwin" }}
# macOS Homebrew
if [[ -f "/opt/homebrew/bin/brew" ]]; then
    eval "$(/opt/homebrew/bin/brew shellenv)"
elif [[ -f "/usr/local/bin/brew" ]]; then
    eval "$(/usr/local/bin/brew shellenv)"
fi
{{- else }}
# Linux Homebrew
if [[ -f "/home/linuxbrew/.linuxbrew/bin/brew" ]]; then
    eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
elif [[ -d "$HOME/.linuxbrew" ]]; then
    eval "$($HOME/.linuxbrew/bin/brew shellenv)"
fi
{{- end }}

# -----------------------------------------------------------------------------
# Oh My Zsh
# -----------------------------------------------------------------------------
export ZSH="$HOME/.oh-my-zsh"

# Theme - Powerlevel10k
ZSH_THEME="powerlevel10k/powerlevel10k"
POWERLEVEL10K_MODE="nerdfont-complete"

# Plugins
plugins=(
    git
    zsh-autosuggestions
    history-substring-search
    brew
    docker-compose
    zsh-interactive-cd
    zsh-syntax-highlighting
{{- if eq .chezmoi.os "darwin" }}
    azure-subscription-prompt
{{- end }}
)

# Load Oh My Zsh
source $ZSH/oh-my-zsh.sh

# -----------------------------------------------------------------------------
# Path Configuration
# -----------------------------------------------------------------------------

# Local bin
export PATH="$HOME/.local/bin:$PATH"

# .NET SDK
export PATH="$HOME/.dotnet:$PATH"
export PATH="$HOME/.dotnet/sdk/9.0.302:$PATH"
export PATH="$PATH:$HOME/.dotnet/tools/"
export DOTNET_ROOT="$HOME/.dotnet"

{{- if eq .chezmoi.os "darwin" }}
# macOS specific paths
export PATH="$HOME/.docker/bin:$PATH"
export PATH="$PATH:$HOME/.lmstudio/bin"
{{- end }}

# -----------------------------------------------------------------------------
# Environment Variables
# -----------------------------------------------------------------------------

# Default editor
export EDITOR="nvim"
export VISUAL="nvim"

# Less configuration
export LESS="-R"

# FZF configuration
export FZF_DEFAULT_COMMAND='rg --files --hidden --follow --glob "!.git/*"'
export FZF_DEFAULT_OPTS='--height 40% --layout=reverse --border'

# -----------------------------------------------------------------------------
# Completion Settings
# -----------------------------------------------------------------------------

# Enable menu-style completion
zstyle ':completion:*' menu select
setopt AUTO_MENU
setopt COMPLETE_IN_WORD
setopt COMPLETE_ALIASES

# Make completion case-insensitive
zstyle ':completion:*' matcher-list 'm:{a-zA-Z}={A-Za-z}'

# Highlight the selected item in the menu
zstyle ':completion:*:*:*:*:*' menu select

# Better history completion
zstyle ':completion:*:history-words' stop yes
zstyle ':completion:*:history-words' remove-all-dups yes
zstyle ':completion:*:history-words' list false
zstyle ':completion:*:history-words' menu yes

# -----------------------------------------------------------------------------
# History
# -----------------------------------------------------------------------------

HISTFILE=~/.zsh_history
HISTSIZE=50000
SAVEHIST=50000
setopt SHARE_HISTORY
setopt HIST_IGNORE_DUPS
setopt HIST_IGNORE_SPACE

# -----------------------------------------------------------------------------
# Key Bindings
# -----------------------------------------------------------------------------

# History substring search (from plugin)
bindkey '^[[A' history-substring-search-up
bindkey '^[[B' history-substring-search-down

# -----------------------------------------------------------------------------
# Aliases
# -----------------------------------------------------------------------------

# Editor
alias v="nvim"
alias vim="nvim"

# Navigation
alias ..="cd .."
alias ...="cd ../.."
alias ....="cd ../../.."

# List files
alias ls="ls --color=auto"
alias ll="ls -alF"
alias la="ls -A"
alias l="ls -CF"

# Git (lazygit is preferred, but keep basics)
alias gs="git status"
alias gd="git diff"
alias gl="git log --oneline -20"
alias lg="lazygit"

# TUI apps
alias y="yazi"
alias k="k9s"

# Tmux
alias t="tmux"
alias ta="tmux attach -t"
alias tn="tmux new -s"
alias tl="tmux list-sessions"

# Safety
alias rm="rm -i"
alias mv="mv -i"
alias cp="cp -i"

# -----------------------------------------------------------------------------
# Dotfiles Management (Chezmoi)
# -----------------------------------------------------------------------------

dotfiles() {
    case "$1" in
        sync)
            # Sync changes to git
            chezmoi re-add
            (
                cd ~/.local/share/chezmoi || exit
                git add -A
                git commit -m "${2:-update dotfiles}"
                git push
            )
            echo "Dotfiles synced to git!"
            ;;
        pull)
            # Pull and apply changes from git
            chezmoi update
            echo "Dotfiles updated from git!"
            ;;
        edit)
            # Edit a dotfile via chezmoi
            if [[ -n "$2" ]]; then
                chezmoi edit "$2"
            else
                echo "Usage: dotfiles edit <file>"
            fi
            ;;
        cd)
            # Go to chezmoi source directory
            cd ~/.local/share/chezmoi || return
            ;;
        diff)
            # Show differences
            chezmoi diff
            ;;
        status)
            # Show git status of dotfiles
            (cd ~/.local/share/chezmoi && git status)
            ;;
        *)
            # Pass through to chezmoi
            chezmoi "$@"
            ;;
    esac
}

# -----------------------------------------------------------------------------
# FZF Integration
# -----------------------------------------------------------------------------

if command -v fzf &> /dev/null; then
    source <(fzf --zsh)
fi

# -----------------------------------------------------------------------------
# Yazi Integration (change directory on exit)
# -----------------------------------------------------------------------------

function yy() {
    local tmp="$(mktemp -t "yazi-cwd.XXXXXX")"
    yazi "$@" --cwd-file="$tmp"
    if cwd="$(cat -- "$tmp")" && [ -n "$cwd" ] && [ "$cwd" != "$PWD" ]; then
        cd -- "$cwd"
    fi
    rm -f -- "$tmp"
}

# -----------------------------------------------------------------------------
# Powerlevel10k Configuration
# -----------------------------------------------------------------------------

# To customize prompt, run `p10k configure` or edit ~/.p10k.zsh
[[ ! -f ~/.p10k.zsh ]] || source ~/.p10k.zsh
